<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<title>QQ</title>
<style>
*{margin:0;padding:0;}
html,body{height:100%;}
body{overflow:hidden;}
iframe{width:100%;height:100%;}
</style>
<script src="./apikey.js"></script>
</head>
<body>
<iframe src="http://w.qq.com" border="0"></iframe>
<script>
	/*global console,require*/
	'use strict';
	window.onload = function(){
		setInterval(updateQQMsg,1000);
	};
	String.prototype.trim=function() {  
		return this.replace(/(^\s*)|(\s*$)/g,'');  
	};
	var lastIndex = -1;
	var qqDoc;
	var canHandle = true;
	// 正则命令判断
	function reg(command, title, end) {
		if (title == null) {
		title = "@";
		}
		return new RegExp(title + command, end);
	};
	// 根据关键词查询
	function readAllOldFiles(title,time) {
		if ((title == null) || title === "" || title.length < 2) {
		return false;
		}
		var fs,searchfile,alreadyRead,checkFinished;
		var files = [];
		var bkcontent = "查询结果:\n";
		alreadyRead = 1;
		fs = require("fs");
		fs.readdir("./daily-welfare", function(err, fd) {
			console.log(err,fd);
			for (var file in fd) {
				if (reg(".md$","").test(fd[file])){
					files.push(fd[file]);
					searchfile(fd[file],title);
				}
		  }
		});
		searchfile = function(name,title) {
			title = title.trim().split(",");
			fs.readFile("./daily-welfare/"+name,function(err,data){
				var lines = data.toString().split('\n');
				for (var t in lines) {
					var line = lines[t];
					// line.toLowerCase().indexOf(title) > -1 && 
					if (line[0] == "-") {
						var keyword = [];
						for (var k in title) {
							if (line.toLowerCase().indexOf(title[k]) > -1) {
								keyword.push("true");
							}
						}
						if (keyword.length == title.length) {
							bkcontent += line.replace("- [","").replace("](","\n").replace(")","")+"\n";
						}
					}
				}
				alreadyRead++
				checkFinished()
			});
		}
		checkFinished = function() {
			if (alreadyRead === files.length) {
				reply(bkcontent);
				console.log(new Date().getTime()-time);
			}
		}
	};
	function updateQQMsg(){
		if(!qqDoc){
			qqDoc = document.querySelector('iframe').contentDocument;
		}else{
			var msgDom = qqDoc.querySelectorAll('.chat_content');
			for(var i=lastIndex+1;i<msgDom.length;i++){
				var content = msgDom[i].innerText;
				var nick = qqDoc.querySelectorAll('.chat_nick')[i].innerText;
				lastIndex = i;
				if(/【(?:每日|伪)福利】/.test(content) && /已记录。/.test(content)){
					return;
				}
				if(/@闭嘴/.test(content) || /@no\-TooSolo/i.test(content)){
					reply('我就看看，闭嘴就闭嘴……');
					return;
				}
				console.log(content);
				// 增加查询曾经加入到每日福利中的链接
				if (reg("查询结果:","").test(content)) {
					return;
				}
				if (reg("old").test(content)) {
					var title = content.replace("@old","");
					readAllOldFiles(title,new Date().getTime());
				};
				if(/((https?:\/\/|www\.)[\w_\.\/\%\&\?\-=:#]+)/.test(content)){
					var logContent = '';
					if(/#每日福利#/.test(content)){
						logContent = '【每日福利】';
					}else{
						logContent = '【伪福利】';
					}
					logContent += content.replace(/((https?:\/\/|www\.)[\w_\.\/\%\&\?\-=:#]+)/,function(string,url,prefix) {
						var realUrl = url;
						if(prefix === 'www.'){
							realUrl = 'http://'+url;
						}
					return '<'+realUrl+'>';
					});
					var fs = require('fs');
					fs.appendFileSync('./log.txt',logContent + '\n');
					reply(logContent + '\n已记录。');
					console.log(logContent);
				}else if(/@toosolo/i.test(content) && !/toosolo/i.test(nick)){
					var url = 'http://www.tuling123.com/openapi/api?key='+window.apikey+'&userid='+encodeURI(nick)+'&info='+encodeURI(content.replace(/@toosolo/i,''));
					ajax(url,function(msg){
						reply(msg);
					});
				}
			}
		}
	}

	function reply(msg){
		qqDoc.querySelector('#chat_textarea').value = msg;
		setTimeout(function(){
			qqDoc.querySelector('#send_chat_btn').click();
		},100);
	}

	function ajax(url,callback){
		var xmlhttp=new XMLHttpRequest();
		xmlhttp.onreadystatechange=function(){
			if (xmlhttp.readyState==4 && xmlhttp.status==200){
				var replyMsg = JSON.parse(xmlhttp.responseText);
				if(replyMsg.code >= 100000){
					var msg = replyMsg.text;
					if(replyMsg.url){
						msg += replyMsg.url;
					}
					callback(msg);
				}
			}
		};
		xmlhttp.open('GET',url,true);
		xmlhttp.send(null);
	}
	
</script>
</body>
</html>
